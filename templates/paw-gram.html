<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Paw-Gram üêæ</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="{{ url_for('static', filename='pawgram.css') }}">
</head>

<body>

  <div class="app">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="logo">
        Paw-Gram üêæ<br>
        <small style="font-size:13px;color:#777;">
          {{ session.get('name') }}
        </small>
      </div>

      <nav>
        <a href="{{ url_for('paw_gram') }}" class="nav-item active">
          <span class="material-symbols-outlined">home</span>
          <span>Home</span>
        </a>

        <a href="{{ url_for('paw_feed') }}" class="nav-item">
          <span class="material-symbols-outlined">pets</span>
          <span>Paw Feed</span>
        </a>

        <a href="{{ url_for('profile', username=session['name']) }}" class="nav-item">
          <span class="material-symbols-outlined">account_circle</span>
          <span>{{ session['name'] }}</span>
        </a>

        <a href="{{ url_for('home') }}" class="nav-item">
          <span class="material-symbols-outlined">pets</span>
          <span>FurrEver</span>
        </a>
      </nav>

      {% if session.get('user_id') %}
      <a href="{{ url_for('logout') }}" class="nav-item logout">
        <span class="material-symbols-outlined">logout</span>
        <span>Logout</span>
      </a>
      {% endif %}

      <div class="create-btn" onclick="openPost()">+ Create Post</div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main">

      <!-- STORIES SECTION -->
      <section class="stories">

        <!-- YOUR STORY -->
        <div class="story"
             {% if my_story %}
             data-image="{{ url_for('static', filename='story_uploads/' + my_story.image) }}"
             data-username="{{ current_user.name }}"
             data-profile="{{ current_user.profile_pic or 'default.png' }}"
             onclick="openStory(this)"
             {% else %}
             onclick="triggerUpload()"
             {% endif %}
        >
          <div class="story-ring">
            <img src="{{ url_for('static', filename='profile_pics/' + (current_user.profile_pic or 'default.png')) }}">
            {% if not my_story %}
            <span class="add">+</span>
            {% endif %}
          </div>
          <p>Your Story</p>
        </div>

        <!-- HIDDEN UPLOAD FORM -->
        <form id="storyUploadForm" action="/upload-story" method="POST" enctype="multipart/form-data">
          <input type="file" name="image" id="storyFileInput" hidden onchange="this.form.submit()">
        </form>

        <!-- FOLLOWING STORIES -->
        {% for story in stories %}
        <div class="story"
             data-image="{{ url_for('static', filename='story_uploads/' + story.image) }}"
             data-username="{{ story.name }}"
             data-profile="{{ story.profile_pic or 'default.png' }}"
             onclick="openStory(this)">
          <div class="story-ring">
            <img src="{{ url_for('static', filename='profile_pics/' + (story.profile_pic or 'default.png')) }}">
          </div>
          <p>{{ story.name }}</p>
        </div>
        {% endfor %}

      </section>

      <!-- POSTS -->
      {% for post in posts %}
      <section class="post">

        <div class="post-header">
          <div class="post-user">
            <img
              src="{{ url_for('static', filename='profile_pics/' ~ (post.profile_pic or 'default.png')) }}"
              class="post-avatar"
            >
            <a href="{{ url_for('profile', username=post.name) }}" class="post-username">
              {{ post.name }}
            </a>
          </div>
        </div>

        <img class="post-img" src="{{ url_for('static', filename='uploads/' + post.image) }}">

        <div class="post-actions">
          <div class="left">
            <span class="material-symbols-outlined paw-icon"
                  data-post-id="{{ post.id }}"
                  onclick="toggleLike(this)">
              pets
            </span>

            <span class="like-count" id="like-count-{{ post.id }}">{{ post.likes }}</span>

            <span class="material-symbols-outlined comment-btn"
                  data-post-id="{{ post.id }}"
                  data-image="{{ url_for('static', filename='uploads/' + post.image) }}"
                  data-username="{{ post.name }}"
                  data-caption="{{ post.caption | e }}"
                  data-profile="{{ post.profile_pic or 'default.png' }}"
                  onclick="openComments(this)">
              comment
            </span>
          </div>
          <span class="material-symbols-outlined">bookmark</span>
        </div>

        <div class="caption">
          <a href="{{ url_for('profile', username=post.name) }}" class="caption-username">
            {{ post.name }}
          </a>
          {{ post.caption }}
        </div>

      </section>
      {% endfor %}

    </main>

    <!-- VIEW POST MODAL -->
    <div id="viewPostModal" class="modal">
      <div class="modal-box">

        <!-- LEFT : IMAGE -->
        <div class="modal-image">
          <img id="viewPostImage">
        </div>

        <!-- RIGHT : COMMENTS -->
        <div class="modal-comments">

          <div class="modal-header">
            <div class="user">
              <img id="viewPostProfile" class="avatar">
              <span id="viewPostUser"></span>
            </div>
            <span class="close-btn" onclick="closeViewPost()">‚úï</span>
          </div>

          <div class="caption">
            <strong id="viewPostUser"></strong>
            <span id="viewPostCaption"></span>
          </div>

          <div id="feedCommentsList" class="feedCommentsList"></div>

          <div class="add-comment">
            <input type="text" id="commentInput" placeholder="Add a comment...">
            <button onclick="addComment()">Post</button>
          </div>

        </div>
      </div>
    </div>

    <!-- STORY MODAL -->
    <div id="storyModal" class="modal">
      <div class="story-box">

        <div class="story-header">
          <div class="story-user">
            <img id="storyProfile" class="avatar">
            <span id="storyUsername"></span>
          </div>
          <span class="close-btn" onclick="closeStory()">‚úï</span>
        </div>

        <img id="storyImage" class="story-full">

      </div>
    </div>

  </div>

  <!-- CREATE POST MODAL -->
  <div class="post-modal" id="postModal">
    <form class="post-box" method="POST" enctype="multipart/form-data">
      <span style="align-self:flex-end;cursor:pointer;" onclick="closePost()">‚úñ</span>
      <b>Create new post</b>
      <textarea name="caption" placeholder="Write something‚Ä¶"></textarea>
      <input type="file" name="image" accept="image/*" required>
      <button type="submit">Post</button>
    </form>
  </div>

  <!-- SCRIPT -->
  <script>
    let currentPostId = null;

    function toggleLike(icon) {
      const postId = icon.dataset.postId;

      fetch("/like-post", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "same-origin",
        body: JSON.stringify({ post_id: postId })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById(`like-count-${postId}`).innerText = data.likes;

        if (data.status === "liked") {
          icon.classList.add("liked");
        } else {
          icon.classList.remove("liked");
        }
      });
    }

    function openComments(el) {
      currentPostId = el.dataset.postId;

      document.getElementById("viewPostImage").src = el.dataset.image;
      document.getElementById("viewPostUser").innerText = el.dataset.username;
      document.getElementById("viewPostCaption").innerText = el.dataset.caption;

      const profilePic = el.dataset.profile
        ? `/static/profile_pics/${el.dataset.profile}`
        : `/static/profile_pics/default.png`;
      document.getElementById("viewPostProfile").src = profilePic;

      loadComments();
      document.getElementById("viewPostModal").style.display = "flex";
    }

    function closeViewPost() {
      document.getElementById("viewPostModal").style.display = "none";
    }

    function loadComments() {
      fetch(`/get-comments/${currentPostId}`, { credentials: "same-origin" })
        .then(res => res.json())
        .then(comments => {
          const list = document.getElementById("feedCommentsList");
          list.innerHTML = "";

          comments.forEach(c => {
            const profilePic = c.profile_pic
              ? `/static/profile_pics/${c.profile_pic}`
              : `/static/profile_pics/default-user.png`;

            list.innerHTML += `
              <div class="comment">
                <img src="${profilePic}" class="comment-pic">
                <div class="comment-text">
                  <strong>${c.name}</strong>
                  <span>${c.text}</span>
                </div>
              </div>
            `;
          });
        });
    }

    function openPost() {
      document.getElementById("postModal").style.display = "flex";
    }

    function closePost() {
      document.getElementById("postModal").style.display = "none";
    }

    function addComment() {
      const input = document.getElementById("commentInput");
      const text = input.value.trim();
      if (!text || !currentPostId) return;

      fetch("/add-comment", {
        method: "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ post_id: currentPostId, comment: text })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          input.value = "";
          loadComments();
        } else {
          alert("Failed to add comment");
        }
      });
    }

    function openStory(el) {
      const image = el.dataset.image;
      const username = el.dataset.username;
      const profile = el.dataset.profile;

      document.getElementById("storyImage").src = image;
      document.getElementById("storyUsername").innerText = username;
      document.getElementById("storyProfile").src = `/static/profile_pics/${profile}`;

      document.getElementById("storyModal").style.display = "flex";
    }

    function triggerUpload() {
      document.getElementById("storyFileInput").click();
    }

    function closeStory() {
      document.getElementById("storyModal").style.display = "none";
    }

  </script>

</body>
</html>